<div class="gallery-container">
  <h2>Image Gallery</h2>
  
  <div class="gallery-controls">
    <app-tag-filter (tagsSelected)="onTagsUpdated($event)" [externallySelectedTags]="activeTags"></app-tag-filter>

    <div class="control-group">
      <label for="folderGallerySelect">Filter by Folder (Optional):</label>
      <select id="folderGallerySelect" [(ngModel)]="selectedFolder" (change)="resetAndLoadImages()" class="folder-select">
        <option value="">All Folders (matching tags)</option>
        <option *ngFor="let folder of availableFolders" [value]="folder.name">
          {{ folder.name }} ({{folder.imageCount}} images)
        </option>
      </select>
    </div>
  </div>

  <div 
    class="image-grid"
    infiniteScroll
    [infiniteScrollDistance]="2" 
    [infiniteScrollThrottle]="300"
    (scrolled)="onScroll()"
    [scrollWindow]="true"
    [immediateCheck]="false">
    <div *ngFor="let image of images" class="image-item">
      <a [href]="apiService.imageServerBaseUrl + image.url" target="_blank" title="Open image in new tab">
        <img [src]="apiService.imageServerBaseUrl + image.url" 
             [alt]="image.fileName" 
             loading="lazy"
             (error)="onImageError($event, image)">
      </a>
      <p class="image-caption" title="{{ image.folderName }}/{{ image.fileName }}">{{ image.folderName }}/{{ image.fileName }}</p>
      <div *ngIf="image.tags && image.tags.length > 0" class="image-tags">
        <span *ngFor="let tag of image.tags" class="tag-badge">{{tag}}</span>
      </div>
    </div>
  </div>

  <div *ngIf="isLoading && images.length > 0" class="status-message loading-more">
    <div class="spinner"></div> Loading more images...
  </div>
  <div *ngIf="isLoading && images.length === 0 && !initialLoadFailed" class="status-message loading-initial">
    <div class="spinner"></div> Loading images...
  </div>
  <div *ngIf="!isLoading && images.length === 0 && (initialLoadDone || initialLoadFailed)" class="status-message no-images">
    <p *ngIf="initialLoadFailed">Failed to load images. Please try again later or check the browser console for errors.</p>
    <p *ngIf="!initialLoadFailed">No images found for the selected criteria. Try adjusting your filters or ensure images are available on the server.</p>
  </div>
  <div *ngIf="allLoaded && images.length > 0 && !isLoading" class="status-message all-loaded">
    All images loaded.
  </div>
</div>